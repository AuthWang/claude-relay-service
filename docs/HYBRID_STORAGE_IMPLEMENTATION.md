# Claude Relay Service - æ··åˆå­˜å‚¨æ¶æ„å®ç°

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬æ¬¡å®ç°ä¸º Claude Relay Service æ·»åŠ äº† Redis + PostgreSQL æ··åˆå­˜å‚¨æ¶æ„ï¼Œæä¾›äº†é«˜æ€§èƒ½ç¼“å­˜å’ŒæŒä¹…åŒ–å­˜å‚¨çš„æœ€ä½³ç»„åˆã€‚è¯¥æ¶æ„æ”¯æŒå¤šç§å­˜å‚¨ç­–ç•¥ï¼Œå…·å¤‡å®Œæ•´çš„é™çº§æœºåˆ¶å’Œæ•°æ®åŒæ­¥åŠŸèƒ½ã€‚

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### âœ… å·²å®ç°åŠŸèƒ½

1. **ç»Ÿä¸€æ•°æ®è®¿é—®å±‚** (`src/models/database.js`)
   - å®Œå…¨å…¼å®¹ç°æœ‰ Redis æ¥å£
   - æ”¯æŒå¤šç§å­˜å‚¨ç­–ç•¥
   - æ™ºèƒ½ç¼“å­˜å’Œé™çº§æœºåˆ¶
   - 100% å‘åå…¼å®¹

2. **æ··åˆå­˜å‚¨ç­–ç•¥**
   - `dual_write`: åŒå†™æ¨¡å¼ (é»˜è®¤)
   - `cache_first`: ç¼“å­˜ä¼˜å…ˆè¯»å–
   - `database_first`: æ•°æ®åº“ä¼˜å…ˆ
   - `redis_only`: ä»… Redis (é™çº§æ¨¡å¼)
   - `postgres_only`: ä»… PostgreSQL

3. **æ™ºèƒ½ç¼“å­˜ç®¡ç†**
   - å¯é…ç½®çš„ TTL ç­–ç•¥
   - è‡ªåŠ¨ç¼“å­˜é¢„çƒ­
   - ç¼“å­˜å¤±æ•ˆå’Œæ›´æ–°æœºåˆ¶
   - æ€§èƒ½ç›‘æ§å’ŒæŒ‡æ ‡

4. **æ•°æ®åº“åˆå§‹åŒ–å™¨** (`src/utils/databaseInit.js`)
   - è‡ªåŠ¨è¿æ¥å’Œå¥åº·æ£€æŸ¥
   - æ•°æ®åŒæ­¥å’Œä¸€è‡´æ€§æ£€æŸ¥
   - é™çº§ç­–ç•¥å¤„ç†
   - æ€§èƒ½ç›‘æ§

5. **ç®¡ç†å·¥å…·å’Œ API**
   - ç®¡ç†å‘˜ API (`/admin/database/*`)
   - å‘½ä»¤è¡Œç®¡ç†å·¥å…· (`scripts/database-manager.js`)
   - å¥åº·æ£€æŸ¥å’Œç›‘æ§ç«¯ç‚¹
   - æ•°æ®åŒæ­¥æ“ä½œ

6. **æœåŠ¡å±‚é‡æ„**
   - `apiKeyService.js` å·²é‡æ„ä½¿ç”¨ç»Ÿä¸€æ•°æ®å±‚
   - ä¿æŒåŸæœ‰æ¥å£ä¸å˜
   - æ”¯æŒæ··åˆå­˜å‚¨æ“ä½œ

7. **é…ç½®ç³»ç»Ÿæ‰©å±•**
   - PostgreSQL è¿æ¥é…ç½®
   - æ··åˆå­˜å‚¨ç­–ç•¥é…ç½®
   - ç¼“å­˜å’ŒåŒæ­¥å‚æ•°
   - ç¯å¢ƒå˜é‡æ”¯æŒ

8. **éƒ¨ç½²å’Œè¿ç»´**
   - Docker Compose æ··åˆæ¶æ„é…ç½®
   - ç›‘æ§å·¥å…·é›†æˆ
   - ç¯å¢ƒå˜é‡æ¨¡æ¿
   - éƒ¨ç½²æ–‡æ¡£

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Claude Relay Service                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   Application Layer                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚  API Services   â”‚    â”‚   Admin APIs    â”‚                â”‚
â”‚  â”‚  (apiKeyService)â”‚    â”‚  (databaseAdmin)â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  Unified Data Access Layer                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚               Database Client                           â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚â”‚
â”‚  â”‚  â”‚   Dual      â”‚  â”‚   Cache     â”‚  â”‚  Database   â”‚    â”‚â”‚
â”‚  â”‚  â”‚   Write     â”‚  â”‚   First     â”‚  â”‚   First     â”‚    â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    Storage Backends                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚      Redis      â”‚              â”‚   PostgreSQL    â”‚       â”‚
â”‚  â”‚   (Cache Layer) â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ (Primary Store) â”‚       â”‚
â”‚  â”‚                 â”‚              â”‚                 â”‚       â”‚
â”‚  â”‚  â€¢ Fast Access â”‚              â”‚  â€¢ ACID Compliance â”‚    â”‚
â”‚  â”‚  â€¢ TTL Support â”‚              â”‚  â€¢ Rich Queries    â”‚    â”‚
â”‚  â”‚  â€¢ Pub/Sub     â”‚              â”‚  â€¢ Backup/Recovery â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµè®¾è®¡

#### å†™å…¥æµç¨‹ (åŒå†™æ¨¡å¼)
```
API Request â†’ Validate â†’ Database.setApiKey()
                            â”œâ”€â†’ PostgreSQL.setApiKey() (ä¸»å­˜å‚¨)
                            â””â”€â†’ Redis.setApiKey()      (ç¼“å­˜)
```

#### è¯»å–æµç¨‹ (ç¼“å­˜ä¼˜å…ˆ)
```
API Request â†’ Database.getApiKey()
                â”œâ”€â†’ Redis.getApiKey()
                â”‚   â”œâ”€ Hit  â†’ Return Data
                â”‚   â””â”€ Miss â†“
                â””â”€â†’ PostgreSQL.getApiKey()
                    â”œâ”€â†’ Cache Result in Redis
                    â””â”€â†’ Return Data
```

## ğŸ“ æ–‡ä»¶ç»“æ„

### æ–°å¢æ–‡ä»¶

```
src/
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ database.js              # ç»Ÿä¸€æ•°æ®è®¿é—®å±‚
â”‚   â””â”€â”€ postgres.js              # PostgreSQL å®¢æˆ·ç«¯ (å·²å­˜åœ¨)
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ databaseInit.js          # æ•°æ®åº“åˆå§‹åŒ–å™¨
â””â”€â”€ routes/
    â””â”€â”€ databaseAdmin.js         # æ•°æ®åº“ç®¡ç† API

scripts/
â””â”€â”€ database-manager.js         # å‘½ä»¤è¡Œç®¡ç†å·¥å…·

config/
â””â”€â”€ config.js                   # æ‰©å±•é…ç½® (å·²æ›´æ–°)

docker-compose.hybrid.yml       # æ··åˆå­˜å‚¨éƒ¨ç½²é…ç½®
.env.example                     # ç¯å¢ƒå˜é‡æ¨¡æ¿ (å·²æ›´æ–°)
```

### ä¿®æ”¹æ–‡ä»¶

```
src/
â”œâ”€â”€ app.js                       # åº”ç”¨åˆå§‹åŒ– (å·²æ›´æ–°)
â”œâ”€â”€ services/
â”‚   â””â”€â”€ apiKeyService.js         # æœåŠ¡å±‚é‡æ„ (å·²æ›´æ–°)
â””â”€â”€ routes/
    â””â”€â”€ admin.js                 # ç®¡ç†è·¯ç”±é›†æˆ (å·²æ›´æ–°)
```

## âš™ï¸ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡é…ç½®

```bash
# PostgreSQL é…ç½®
POSTGRES_ENABLED=true
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_DATABASE=claude_relay
POSTGRES_USER=postgres
POSTGRES_PASSWORD=your_password

# å­˜å‚¨ç­–ç•¥é…ç½®
DATABASE_STRATEGY=dual_write

# ç¼“å­˜é…ç½®
CACHE_API_KEY_TTL=86400
CACHE_SESSION_TTL=1800
CACHE_USAGE_STATS_TTL=300

# åŒæ­¥é…ç½®
DATABASE_SYNC_ENABLED=true
DATABASE_SYNC_INTERVAL=3600000
DATABASE_SYNC_ON_STARTUP=true
```

### å­˜å‚¨ç­–ç•¥è¯´æ˜

| ç­–ç•¥ | æè¿° | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| `dual_write` | åŒæ—¶å†™å…¥ä¸¤ä¸ªæ•°æ®åº“ï¼Œç¼“å­˜ä¼˜å…ˆè¯»å– | ç”Ÿäº§ç¯å¢ƒ (æ¨è) |
| `cache_first` | Redis ä¼˜å…ˆï¼ŒPostgreSQL å¤‡ç”¨ | é«˜æ€§èƒ½åœºæ™¯ |
| `database_first` | PostgreSQL ä¼˜å…ˆï¼ŒRedis ç¼“å­˜ | æ•°æ®ä¸€è‡´æ€§ä¼˜å…ˆ |
| `redis_only` | ä»…ä½¿ç”¨ Redis | é™çº§æ¨¡å¼ |
| `postgres_only` | ä»…ä½¿ç”¨ PostgreSQL | çº¯æŒä¹…åŒ–åœºæ™¯ |

## ğŸš€ éƒ¨ç½²æŒ‡å—

### 1. åŸºç¡€éƒ¨ç½²

```bash
# 1. æ›´æ–°ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶é…ç½®æ•°æ®åº“è¿æ¥

# 2. å¯åŠ¨æ··åˆå­˜å‚¨æœåŠ¡
docker-compose -f docker-compose.hybrid.yml up -d

# 3. éªŒè¯æœåŠ¡çŠ¶æ€
docker-compose -f docker-compose.hybrid.yml ps
```

### 2. ç›‘æ§éƒ¨ç½²

```bash
# å¯åŠ¨åŒ…å«ç›‘æ§å·¥å…·çš„å®Œæ•´æœåŠ¡
docker-compose -f docker-compose.hybrid.yml --profile monitoring up -d

# è®¿é—®ç›‘æ§ç•Œé¢
# - Redis Insight: http://localhost:8001
# - pgAdmin: http://localhost:5050
# - Grafana: http://localhost:3001
```

### 3. å‘½ä»¤è¡Œç®¡ç†

```bash
# æ£€æŸ¥æ•°æ®åº“å¥åº·çŠ¶æ€
node scripts/database-manager.js health --verbose

# æ‰§è¡Œæ•°æ®åŒæ­¥
node scripts/database-manager.js sync --source redis --target postgres --force

# æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
node scripts/database-manager.js check-consistency

# åˆ‡æ¢å­˜å‚¨ç­–ç•¥
node scripts/database-manager.js switch-strategy dual_write --force

# ç›‘æ§æ€§èƒ½æŒ‡æ ‡
node scripts/database-manager.js metrics --watch
```

## ğŸ”§ ç®¡ç† API

### å¥åº·æ£€æŸ¥
```bash
GET /admin/database/health
GET /admin/database/status
GET /admin/database/metrics
```

### æ•°æ®åŒæ­¥
```bash
POST /admin/database/sync/redis-to-postgres
POST /admin/database/sync/postgres-to-redis
```

### ç­–ç•¥ç®¡ç†
```bash
POST /admin/database/strategy/dual-write
POST /admin/database/strategy/redis-only
POST /admin/database/strategy/postgres-only
```

### ä¸€è‡´æ€§æ£€æŸ¥
```bash
GET /admin/database/consistency-check
```

## ğŸ“Š æ€§èƒ½ç›‘æ§

### å…³é”®æŒ‡æ ‡

- **æ€»æ“ä½œæ•°**: æ•°æ®åº“æ“ä½œçš„æ€»æ¬¡æ•°
- **ç¼“å­˜å‘½ä¸­ç‡**: Redis ç¼“å­˜çš„å‘½ä¸­ç‡
- **é”™è¯¯ç‡**: æ•°æ®åº“æ“ä½œçš„é”™è¯¯ç‡
- **è¿æ¥çŠ¶æ€**: å„æ•°æ®åº“çš„è¿æ¥çŠ¶æ€
- **å“åº”æ—¶é—´**: å„æ“ä½œçš„å¹³å‡å“åº”æ—¶é—´

### ç›‘æ§æ–¹å¼

1. **ç®¡ç† API**: `/admin/database/metrics`
2. **å‘½ä»¤è¡Œå·¥å…·**: `database-manager.js metrics --watch`
3. **åº”ç”¨æ—¥å¿—**: ç»“æ„åŒ–æ—¥å¿—è¾“å‡º
4. **Grafana ä»ªè¡¨æ¿**: å¯è§†åŒ–ç›‘æ§ (å¯é€‰)

## ğŸ› ï¸ æ•…éšœå¤„ç†

### å¸¸è§é—®é¢˜

1. **PostgreSQL è¿æ¥å¤±è´¥**
   ```bash
   # æ£€æŸ¥æœåŠ¡çŠ¶æ€
   docker-compose ps postgres

   # æŸ¥çœ‹æ—¥å¿—
   docker-compose logs postgres

   # åˆ‡æ¢åˆ° Redis-only æ¨¡å¼
   node scripts/database-manager.js switch-strategy redis-only --force
   ```

2. **æ•°æ®ä¸ä¸€è‡´**
   ```bash
   # æ£€æŸ¥ä¸€è‡´æ€§
   node scripts/database-manager.js check-consistency

   # æ‰§è¡ŒåŒæ­¥
   node scripts/database-manager.js sync --source postgres --target redis --force
   ```

3. **æ€§èƒ½é—®é¢˜**
   ```bash
   # ç›‘æ§æŒ‡æ ‡
   node scripts/database-manager.js metrics --watch

   # æ£€æŸ¥ç¼“å­˜å‘½ä¸­ç‡
   curl http://localhost:3000/admin/database/metrics
   ```

### é™çº§ç­–ç•¥

ç³»ç»Ÿä¼šè‡ªåŠ¨æ ¹æ®æ•°æ®åº“å¯ç”¨æ€§è°ƒæ•´ç­–ç•¥ï¼š

- å¦‚æœ PostgreSQL ä¸å¯ç”¨ â†’ è‡ªåŠ¨åˆ‡æ¢åˆ° `redis_only`
- å¦‚æœ Redis ä¸å¯ç”¨ â†’ è‡ªåŠ¨åˆ‡æ¢åˆ° `postgres_only`
- å¦‚æœä¸¤è€…éƒ½ä¸å¯ç”¨ â†’ æŠ›å‡ºé”™è¯¯

## ğŸ”’ å®‰å…¨è€ƒè™‘

1. **æ•°æ®åŠ å¯†**: PostgreSQL æ”¯æŒ SSL/TLS è¿æ¥
2. **è®¿é—®æ§åˆ¶**: æ•°æ®åº“ç”¨æˆ·æƒé™æœ€å°åŒ–
3. **æ•æ„Ÿæ•°æ®**: ç»§ç»­ä½¿ç”¨ AES åŠ å¯†å­˜å‚¨
4. **ç½‘ç»œéš”ç¦»**: Docker ç½‘ç»œéš”ç¦»
5. **å¤‡ä»½ç­–ç•¥**: PostgreSQL å®šæœŸå¤‡ä»½

## ğŸ“ˆ å‡çº§è·¯å¾„

### ä»çº¯ Redis è¿ç§»

1. **éƒ¨ç½²é˜¶æ®µ**:
   - éƒ¨ç½² PostgreSQL å®ä¾‹
   - é…ç½®ç¯å¢ƒå˜é‡
   - é‡å¯åº”ç”¨æœåŠ¡

2. **æ•°æ®è¿ç§»**:
   ```bash
   # åŒæ­¥ç°æœ‰æ•°æ®åˆ° PostgreSQL
   node scripts/database-manager.js sync --source redis --target postgres --force
   ```

3. **ç­–ç•¥åˆ‡æ¢**:
   ```bash
   # åˆ‡æ¢åˆ°åŒå†™æ¨¡å¼
   node scripts/database-manager.js switch-strategy dual_write --force
   ```

4. **éªŒè¯é˜¶æ®µ**:
   ```bash
   # æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
   node scripts/database-manager.js check-consistency

   # ç›‘æ§ç³»ç»ŸçŠ¶æ€
   node scripts/database-manager.js health --verbose
   ```

## ğŸš¦ æµ‹è¯•å»ºè®®

### å•å…ƒæµ‹è¯•
- æ•°æ®åº“è¿æ¥æµ‹è¯•
- CRUD æ“ä½œæµ‹è¯•
- ç¼“å­˜ç­–ç•¥æµ‹è¯•
- é™çº§æœºåˆ¶æµ‹è¯•

### é›†æˆæµ‹è¯•
- æ•°æ®åŒæ­¥æµ‹è¯•
- æ•…éšœè½¬ç§»æµ‹è¯•
- æ€§èƒ½å‹åŠ›æµ‹è¯•
- ä¸€è‡´æ€§éªŒè¯æµ‹è¯•

### ç”Ÿäº§éªŒè¯
- ç°åº¦å‘å¸ƒ
- ç›‘æ§æŒ‡æ ‡éªŒè¯
- å›æ»šå‡†å¤‡
- æ€§èƒ½åŸºå‡†æµ‹è¯•

## ğŸ“š å‚è€ƒèµ„æ–™

- [PostgreSQL å®˜æ–¹æ–‡æ¡£](https://www.postgresql.org/docs/)
- [Redis å®˜æ–¹æ–‡æ¡£](https://redis.io/documentation)
- [Docker Compose æ–‡æ¡£](https://docs.docker.com/compose/)
- [Node.js pg å®¢æˆ·ç«¯](https://node-postgres.com/)
- [ioredis å®¢æˆ·ç«¯](https://github.com/luin/ioredis)

---

**å®ç°å®Œæˆ**: 2024å¹´12æœˆ
**æ¶æ„å¸ˆ**: Architecture-Expert
**ç‰ˆæœ¬**: v1.0.0

è¯¥å®ç°æä¾›äº†ä¸€ä¸ªå®Œæ•´ã€å¯é ã€é«˜æ€§èƒ½çš„æ··åˆå­˜å‚¨è§£å†³æ–¹æ¡ˆï¼Œä¸º Claude Relay Service çš„æ‰©å±•æ€§å’Œå¯é æ€§å¥ å®šäº†åšå®åŸºç¡€ã€‚